{% extends "base.html" %}
{% load static %}

{% block title %}Finalizar Registro - SudaPlay{% endblock %}

{% block content %}
<div class="container">
    <div class="login-card">
        <div class="login-header">
            <img src="{% static 'img/logo.svg' %}" alt="Logo" class="login-card-logo">
            <h1>Finalizar Registro</h1>
            <p>Configura tu identidad en SudaPlay</p>
        </div>

        <form method="post" action="{% url 'socialaccount_signup' %}" class="login-form" id="signup-form">
            {% csrf_token %}

            {% for field in form %}
            {% if field.name == 'email' %}
            <input type="hidden" name="{{ field.name }}" id="id_email"
                value="{{ field.value|default:field.initial|default:'' }}">
            {% else %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">
                    {% if field.name == 'username' %}Nombre de Usuario (Apodo)
                    {% elif 'password' in field.name %}Nueva Contraseña
                    {% else %}{{ field.label }}{% endif %}
                </label>
                <div class="input-wrapper" id="wrapper-{{ field.auto_id }}">
                    {% if field.name == 'username' %}
                    <i class="fa fa-user input-icon"></i>
                    {% elif 'password' in field.name %}
                    <i class="fa fa-lock input-icon"></i>
                    {% endif %}
                    {{ field }}
                </div>
                <div class="validation-msg" id="msg-{{ field.auto_id }}"></div>
                {% if field.errors %}
                <div class="form-error">
                    {% for error in field.errors %}<p>✗ {{ error }}</p>{% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}

            {% if redirect_field_value %}
            <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
            {% endif %}

            <button type="submit" class="btn-login" id="submit-btn" style="margin-top: 20px;">
                Crea tu Cuenta
            </button>
        </form>
    </div>
</div>

<style>
    .validation-msg {
        font-size: 0.8rem;
        margin-top: 5px;
        transition: all 0.3s ease;
        height: 0;
        overflow: hidden;
        opacity: 0;
    }

    .validation-msg.visible {
        height: auto;
        opacity: 1;
        margin-bottom: 5px;
    }

    .msg-error {
        color: #ff4d4d;
        border-left: 2px solid #ff4d4d;
        padding-left: 8px;
    }

    .msg-success {
        color: var(--neon-green);
        border-left: 2px solid var(--neon-green);
        padding-left: 8px;
    }

    .input-wrapper {
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .input-wrapper.valid-field {
        border-color: var(--neon-green) !important;
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.3) !important;
    }

    .input-wrapper.invalid-field {
        border-color: #ff4d4d !important;
        box-shadow: 0 0 15px rgba(255, 77, 77, 0.3) !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const usernameInput = document.getElementById('id_username');
        const pass1Input = document.getElementById('id_password1');
        const pass2Input = document.getElementById('id_password2');
        const submitBtn = document.getElementById('submit-btn');

        let isUsernameValid = false;
        let isPasswordValid = false;
        let passwordsMatch = false;

        function updateSubmitButton() {
            submitBtn.disabled = !(isUsernameValid && isPasswordValid && passwordsMatch);
            submitBtn.style.opacity = submitBtn.disabled ? '0.5' : '1';
        }

        // Validación de Username
        if (usernameInput) {
            usernameInput.addEventListener('input', async function () {
                const value = this.value;
                const msgDiv = document.getElementById('msg-id_username');
                const wrapper = document.getElementById('wrapper-id_username');

                if (value.length < 3) {
                    msgDiv.classList.remove('visible');
                    wrapper.classList.remove('valid-field', 'invalid-field');
                    isUsernameValid = false;
                } else {
                    try {
                        const response = await fetch(`{% url 'login:check_availability' %}?username=${encodeURIComponent(value)}`);
                        const data = await response.json();

                        if (data.is_taken) {
                            msgDiv.innerHTML = '✗ Apodo ya en uso';
                            msgDiv.className = 'validation-msg visible msg-error';
                            wrapper.classList.add('invalid-field');
                            wrapper.classList.remove('valid-field');
                            isUsernameValid = false;
                        } else {
                            msgDiv.innerHTML = '✓ ¡Apodo disponible!';
                            msgDiv.className = 'validation-msg visible msg-success';
                            wrapper.classList.add('valid-field');
                            wrapper.classList.remove('invalid-field');
                            isUsernameValid = true;
                        }
                    } catch (err) {
                        console.error('Error validation:', err);
                    }
                }
                updateSubmitButton();
            });
        }

        // Validación de Password 1
        if (pass1Input) {
            pass1Input.addEventListener('input', function () {
                const value = this.value;
                const msgDiv = document.getElementById('msg-id_password1');
                const wrapper = document.getElementById('wrapper-id_password1');

                if (value.length === 0) {
                    msgDiv.classList.remove('visible');
                    wrapper.classList.remove('valid-field', 'invalid-field');
                    isPasswordValid = false;
                } else if (value.length < 8) {
                    msgDiv.innerHTML = '✗ Mínimo 8 caracteres';
                    msgDiv.className = 'validation-msg visible msg-error';
                    wrapper.classList.add('invalid-field');
                    wrapper.classList.remove('valid-field');
                    isPasswordValid = false;
                } else {
                    msgDiv.innerHTML = '✓ Contraseña segura';
                    msgDiv.className = 'validation-msg visible msg-success';
                    wrapper.classList.add('valid-field');
                    wrapper.classList.remove('invalid-field');
                    isPasswordValid = true;
                }
                checkMatch();
                updateSubmitButton();
            });
        }

        // Validación de Match
        function checkMatch() {
            if (!pass2Input) return;
            const p1 = pass1Input.value;
            const p2 = pass2Input.value;
            const msgDiv = document.getElementById('msg-id_password2');
            const wrapper = document.getElementById('wrapper-id_password2');

            if (p2.length === 0) {
                msgDiv.classList.remove('visible');
                wrapper.classList.remove('valid-field', 'invalid-field');
                passwordsMatch = false;
            } else if (p1 === p2) {
                msgDiv.innerHTML = '✓ Las contraseñas coinciden';
                msgDiv.className = 'validation-msg visible msg-success';
                wrapper.classList.add('valid-field');
                wrapper.classList.remove('invalid-field');
                passwordsMatch = true;
            } else {
                msgDiv.innerHTML = '✗ Las contraseñas no coinciden';
                msgDiv.className = 'validation-msg visible msg-error';
                wrapper.classList.add('invalid-field');
                wrapper.classList.remove('valid-field');
                passwordsMatch = false;
            }
        }

        if (pass2Input) {
            pass2Input.addEventListener('input', () => {
                checkMatch();
                updateSubmitButton();
            });
        }
    });
</script>
{% endblock %}