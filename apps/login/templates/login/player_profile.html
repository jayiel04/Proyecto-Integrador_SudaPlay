{% extends "base.html" %}
{% load static %}

{% block title %}Perfil de {{ target_user.username }} - SudaPlay{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 860px;
        margin: calc(var(--navbar-height) + 2rem) auto 2rem;
        padding: 0 1.25rem;
    }
    .profile-card {
        background: var(--color-card-bg, rgba(2, 22, 22, 0.85));
        border: 1px solid rgba(0, 255, 255, 0.2);
        border-radius: 1.25rem;
        padding: 2.25rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 255, 255, 0.05);
    }
    .profile-hero {
        display: flex;
        align-items: center;
        gap: 2rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .profile-avatar-wrapper {
        position: relative;
    }
    .profile-avatar-img, .profile-avatar-fallback {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--neon-cyan, #00ffff);
        box-shadow: 0 0 25px rgba(0, 255, 255, 0.3);
    }
    .profile-avatar-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #222;
        font-size: 3.5rem;
        color: var(--neon-cyan, #00ffff);
    }
    .profile-info-primary {
        flex: 1;
        min-width: 250px;
    }
    .profile-hero-title {
        font-size: 2.2rem;
        margin: 0 0 0.5rem;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }
    .profile-role, .profile-joined {
        margin: 0 0 0.5rem;
        font-size: 0.95rem;
        color: #aaa;
    }
    .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .role-admin { background: rgba(255, 59, 59, 0.2); color: #ff3b3b; border: 1px solid rgba(255, 59, 59, 0.5); }
    .role-mod { background: rgba(255, 165, 0, 0.2); color: #ffa500; border: 1px solid rgba(255, 165, 0, 0.5); }
    .role-user { background: rgba(0, 255, 255, 0.1); color: var(--neon-cyan, #00ffff); border: 1px solid rgba(0, 255, 255, 0.3); }
    
    .profile-content-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
    }
    @media (max-width: 768px) {
        .profile-content-grid { grid-template-columns: 1fr; }
        .profile-friend-actions { margin-left: 0 !important; width: 100%; justify-content: flex-start; margin-top: 1rem; }
    }
    .profile-section {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .profile-section-title {
        font-size: 1.2rem;
        margin-top: 0;
        margin-bottom: 1.2rem;
        color: var(--neon-cyan, #00ffff);
        display: flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .profile-bio-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #ddd;
        margin: 0;
    }
    .profile-stats-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .stat-card {
        background: rgba(255,255,255,0.05);
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .stat-icon {
        font-size: 1.5rem;
        color: var(--neon-cyan, #00ffff);
    }
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
    }
    .stat-label {
        font-size: 0.85rem;
        color: #aaa;
        text-transform: uppercase;
        flex: 1;
    }
    .user-games-showcase {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    .game-mini-card {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .game-mini-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        border-color: rgba(0, 255, 255, 0.4);
    }
    .game-mini-thumb {
        width: 100%;
        height: 120px;
        object-fit: cover;
    }
    .game-mini-thumb.fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #222;
        font-size: 2rem;
        color: #555;
    }
    .game-mini-info {
        padding: 1rem;
    }
    .game-mini-info h4 {
        margin: 0 0 0.5rem;
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .game-mini-meta {
        font-size: 0.8rem;
        color: #aaa;
        margin-bottom: 1rem;
    }
    .game-mini-link {
        display: inline-block;
        padding: 5px 10px;
        background: rgba(0, 255, 255, 0.1);
        color: var(--neon-cyan, #00ffff);
        text-decoration: none;
        border-radius: 5px;
        font-size: 0.85rem;
        border: 1px solid rgba(0, 255, 255, 0.3);
        transition: background 0.2s;
    }
    .game-mini-link:hover {
        background: rgba(0, 255, 255, 0.3);
    }
    .empty-state-card {
        text-align: center;
        padding: 3rem 1rem;
        color: #888;
    }
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-card profile-card-main">
        <div class="profile-hero">
            <div class="profile-avatar-wrapper">
                {% if profile.avatar %}
                    <img src="{{ profile.avatar.url }}" alt="Avatar de {{ target_user.username }}" class="profile-avatar-img" id="player-avatar-preview">
                {% else %}
                    <div class="profile-avatar-fallback">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
                <div class="profile-avatar-ring"></div>
            </div>
            
            <div class="profile-info-primary">
                <h1 class="profile-hero-title">{{ target_user.username }}</h1>
                <p class="profile-role">
                    {% if profile.role == 'admin' %}
                    <span class="role-badge role-admin"><i class="fas fa-shield-alt"></i> Administrador</span>
                    {% elif profile.role == 'moderator' %}
                    <span class="role-badge role-mod"><i class="fas fa-gavel"></i> Moderador</span>
                    {% else %}
                    <span class="role-badge role-user"><i class="fas fa-gamepad"></i> Jugador</span>
                    {% endif %}
                </p>
                <p class="profile-joined"><i class="far fa-calendar-alt"></i> Miembro desde {{ target_user.date_joined|date:"M Y" }}</p>
            </div>

            <!-- Friend Actions -->
            <div class="profile-friend-actions" style="margin-left: auto; display: flex; align-items: center;" 
                 data-target-id="{{ target_user.id }}" 
                 data-request-url="{% url 'login:send_friend_request' %}"
                 data-remove-url="{% url 'login:remove_friend' %}">
                
                {% csrf_token %}
                
                {% if friendship_status == 'none' %}
                    <button class="profile-primary-btn btn-send-request" style="font-size: 0.9rem;">
                        <i class="fas fa-user-plus"></i> Añadir amigo
                    </button>
                    <span class="action-feedback" style="display:none; color: #00ff00; font-size: 0.85rem; margin-left: 10px;"></span>
                
                {% elif friendship_status == 'pending_sent' %}
                    <button class="profile-secondary-btn" disabled style="opacity: 0.7; cursor: default; font-size: 0.9rem;">
                        <i class="fas fa-clock"></i> Solicitud enviada
                    </button>
                
                {% elif friendship_status == 'pending_received' %}
                    <span style="color: var(--neon-cyan); font-size: 0.9rem; margin-right: 10px;"><i class="fas fa-exclamation-circle"></i> Te ha enviado una solicitud</span>
                    <a href="{% url 'login:profile' %}" class="profile-primary-btn" style="font-size: 0.9rem; text-decoration: none;">
                        Ver en mi perfil
                    </a>
                
                {% elif friendship_status == 'friends' %}
                    <a href="{% url 'chat:chat' profile.user.username %}" class="profile-primary-btn" style="font-size: 0.9rem; text-decoration: none; display: inline-flex;">
                        <i class="fas fa-comment-dots"></i> Chatear
                    </a>
                    <button class="profile-secondary-btn btn-friends" style="font-size: 0.9rem; border-color: #00ff00; color: #00ff00; cursor: default; margin-left:10px;">
                        <i class="fas fa-user-check"></i> Amigos
                    </button>
                    <button class="btn-remove-friend" style="background: transparent; border: 1px solid rgba(255,0,0,0.5); color: #ff4444; border-radius: 8px; padding: 8px 12px; margin-left: 10px; cursor: pointer; transition: all 0.2s;" title="Eliminar amigo">
                        <i class="fas fa-user-times"></i>
                    </button>
                {% endif %}
            </div>
        </div>

        <div class="profile-content-grid">
            <div class="profile-sidebar">
                <div class="profile-section">
                    <h3 class="profile-section-title"><i class="fas fa-address-card"></i> Sobre mí</h3>
                    <div class="profile-bio-box">
                        {% if profile.bio %}
                            <p class="profile-bio-text">{{ profile.bio|linebreaksbr }}</p>
                        {% else %}
                            <p class="profile-bio-text" style="color: #666; font-style: italic;">Este usuario no ha escrito una biografía todavía.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="profile-section stats-section">
                    <h3 class="profile-section-title"><i class="fas fa-chart-line"></i> Estadísticas</h3>
                    <div class="profile-stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-gamepad stat-icon"></i>
                            <span class="stat-value">{{ user_games|length }}</span>
                            <span class="stat-label">Juegos Publicados</span>
                        </div>
                        <div class="stat-card" style="margin-top: 10px;">
                            <i class="fas fa-user-friends stat-icon"></i>
                            <span class="stat-value">{{ profile.friends.count }}</span>
                            <span class="stat-label">Amigos</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-main-content">
                <div class="profile-section">
                    <h3 class="profile-section-title"><i class="fas fa-cubes"></i> Juegos Publicados</h3>
                    {% if user_games %}
                        <div class="user-games-showcase">
                            {% for game in user_games %}
                            <div class="game-mini-card">
                                {% if game.thumbnail %}
                                <img src="{{ game.thumbnail.url }}" alt="{{ game.title }}" class="game-mini-thumb">
                                {% else %}
                                <div class="game-mini-thumb fallback">
                                    <i class="fas fa-image"></i>
                                </div>
                                {% endif %}
                                <div class="game-mini-info">
                                    <h4>{{ game.title }}</h4>
                                    <div class="game-mini-meta">
                                        <span><i class="fas fa-folder"></i> {{ game.category.name }}</span>
                                    </div>
                                    <a href="{% url 'web:game_detail' game.pk %}" class="game-mini-link">Comenzar <i class="fas fa-play-circle"></i></a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state-card">
                            <div class="empty-state-icon"><i class="fas fa-box-open"></i></div>
                            <h4>Sin juegos públicos</h4>
                            <p>{{ target_user.username }} no ha publicado ningún juego todavía.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.querySelector('.profile-friend-actions');
        if (!container) return;

        const csrfToken = container.querySelector('[name=csrfmiddlewaretoken]').value;
        const targetId = container.dataset.targetId;
        const requestUrl = container.dataset.requestUrl;
        const removeUrl = container.dataset.removeUrl;

        const btnSend = container.querySelector('.btn-send-request');
        const feedback = container.querySelector('.action-feedback');
        const btnRemove = container.querySelector('.btn-remove-friend');

        if (btnSend) {
            btnSend.addEventListener('click', async () => {
                btnSend.disabled = true;
                btnSend.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                
                try {
                    const response = await fetch(requestUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ to_user_id: targetId })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        btnSend.style.display = 'none';
                        feedback.innerHTML = '<i class="fas fa-check"></i> Solicitud enviada';
                        feedback.style.display = 'inline-block';
                    } else {
                        btnSend.disabled = false;
                        btnSend.innerHTML = '<i class="fas fa-user-plus"></i> Añadir amigo';
                        alert(data.error || 'Ocurrió un error.');
                    }
                } catch (err) {
                    btnSend.disabled = false;
                    btnSend.innerHTML = '<i class="fas fa-user-plus"></i> Añadir amigo';
                    alert('Error de conexión.');
                }
            });
        }

        if (btnRemove) {
            btnRemove.addEventListener('click', async () => {
                if (!confirm("¿Seguro que quieres eliminar a este jugador de tus amigos?")) return;
                
                btnRemove.disabled = true;
                btnRemove.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                try {
                    const response = await fetch(removeUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ friend_id: targetId })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        location.reload(); // Reload to show Add Friend button
                    } else {
                        btnRemove.disabled = false;
                        btnRemove.innerHTML = '<i class="fas fa-user-times"></i>';
                        alert(data.error || 'Ocurrió un error.');
                    }
                } catch (err) {
                    btnRemove.disabled = false;
                    btnRemove.innerHTML = '<i class="fas fa-user-times"></i>';
                    alert('Error de conexión.');
                }
            });
        }
    });
</script>
{% endblock %}
